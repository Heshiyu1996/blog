(window.webpackJsonp=window.webpackJsonp||[]).push([[172],{717:function(a,t,s){"use strict";s.r(t);var e=s(43),v=Object(e.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"jsbridge通信"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#jsbridge通信"}},[a._v("#")]),a._v(" JSBridge通信")]),a._v(" "),s("p"),s("div",{staticClass:"table-of-contents"},[s("ul",[s("li",[s("a",{attrs:{href:"#jsbridge通信"}},[a._v("JSBridge通信")]),s("ul",[s("li",[s("a",{attrs:{href:"#现有方案"}},[a._v("现有方案")])]),s("li",[s("a",{attrs:{href:"#两端通信方式"}},[a._v("两端通信方式")])]),s("li",[s("a",{attrs:{href:"#业务上的使用"}},[a._v("业务上的使用")])]),s("li",[s("a",{attrs:{href:"#其他"}},[a._v("其他")])]),s("li",[s("a",{attrs:{href:"#参考"}},[a._v("参考")])])])])])]),s("p"),a._v(" "),s("h2",{attrs:{id:"现有方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#现有方案"}},[a._v("#")]),a._v(" 现有方案")]),a._v(" "),s("ol",[s("li",[s("p",[a._v("通过采取 2 种方式来提供底层的通讯能力")]),a._v(" "),s("ul",[s("li",[a._v("“Native 向 JS上下文 注入对象” （iOS）")]),a._v(" "),s("li",[a._v("“重写prompt”（Android）")])])]),a._v(" "),s("li",[s("p",[a._v("提供 "),s("code",[a._v("JS SDK")]),a._v("，并封装到 "),s("code",[a._v("npm")]),a._v("包，供业务使用")])])]),a._v(" "),s("h2",{attrs:{id:"两端通信方式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#两端通信方式"}},[a._v("#")]),a._v(" 两端通信方式")]),a._v(" "),s("p",[a._v("两端通信方式分为："),s("strong",[a._v("JS调用Native、Native调用JS")]),a._v("。")]),a._v(" "),s("h3",{attrs:{id:"js调用native"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#js调用native"}},[a._v("#")]),a._v(" JS调用Native")]),a._v(" "),s("p",[a._v("JS 调用 Native，有 3 种 通信方法：")]),a._v(" "),s("ul",[s("li",[s("p",[a._v("拦截Scheme")]),a._v(" "),s("ul",[s("li",[s("strong",[a._v("原理：")]),a._v(" “客户端” 拦截跳转请求，并解析上面的参数。")]),a._v(" "),s("li",[s("strong",[a._v("缺点")]),a._v("：加载后立即通信会白屏（iOS）；长度限制；")])])]),a._v(" "),s("li",[s("p",[a._v("重写prompt")]),a._v(" "),s("ul",[s("li",[s("strong",[a._v("原理：")]),a._v(" JS 调用弹窗，会触发 WebView 的事件监听（"),s("code",[a._v("onJsPrompt")]),a._v("）。")]),a._v(" "),s("li",[s("strong",[a._v("缺点：")]),a._v(" 需额外作兼容（iOS）")])])]),a._v(" "),s("li",[s("p",[a._v("向 JS的上下文 注入对象、方法")]),a._v(" "),s("ul",[s("li",[s("strong",[a._v("原理：")]),a._v(" 通过 WebView 向 JS的上下文 注入对象、方法")])])])]),a._v(" "),s("h4",{attrs:{id:"重写prompt"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#重写prompt"}},[a._v("#")]),a._v(" 重写prompt")]),a._v(" "),s("p",[a._v("在 JS 调用（"),s("code",[a._v("window.prompt")]),a._v("）时，会被 "),s("code",[a._v("WebView")]),a._v(" 的 "),s("code",[a._v("onJsPrompt")]),a._v(" 监听。")]),a._v(" "),s("blockquote",[s("p",[a._v("因为 "),s("code",[a._v("window.prompt")]),a._v(" 占用率会较低，最终采用它。")])]),a._v(" "),s("h4",{attrs:{id:"向-js的上下文-注入对象、方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#向-js的上下文-注入对象、方法"}},[a._v("#")]),a._v(" 向 JS的上下文 注入对象、方法")]),a._v(" "),s("p",[a._v("JS 通过 这个对象（或方法） 进行调用时，执行对应的逻辑操作，直接调用 Native 的方法。")]),a._v(" "),s("ul",[s("li",[s("p",[a._v("iOS")]),a._v(" "),s("ul",[s("li",[a._v("WKWebView： "),s("code",[a._v("window.webkit.messageHandlers")]),a._v(" 下 的 "),s("code",[a._v("postMessage")]),a._v("方法")]),a._v(" "),s("li",[a._v("UIWebView： "),s("code",[a._v("JavaScriptScore")])])])]),a._v(" "),s("li",[s("p",[a._v("Android：")]),a._v(" "),s("ul",[s("li",[a._v("4.2及以上："),s("code",[a._v("addJavascriptInterface")])])])])]),a._v(" "),s("h3",{attrs:{id:"native调用js"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#native调用js"}},[a._v("#")]),a._v(" Native调用JS")]),a._v(" "),s("p",[a._v("H5 将 JS方法 暴露在 "),s("code",[a._v("window")]),a._v("对象 给 Native 调用。")]),a._v(" "),s("blockquote",[s("p",[a._v("原理是让 Native 去执行 “JS代码字符串”。")])]),a._v(" "),s("ul",[s("li",[s("p",[a._v("iOS")]),a._v(" "),s("ul",[s("li",[a._v("WKWebView： "),s("code",[a._v("evaluateJavaScript")])]),a._v(" "),s("li",[a._v("UIWebView： "),s("code",[a._v("stringByEvaluatingJavaScriptFromString")])])])]),a._v(" "),s("li",[s("p",[a._v("Android：")]),a._v(" "),s("ul",[s("li",[a._v("4.4以上："),s("code",[a._v("evaluateJavascript")])]),a._v(" "),s("li",[a._v("4.4及以下： "),s("code",[a._v('WwbView.loadUrl("javascript:function()")')])])])])]),a._v(" "),s("h2",{attrs:{id:"业务上的使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#业务上的使用"}},[a._v("#")]),a._v(" 业务上的使用")]),a._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 注册Api")]),a._v("\nmnb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("addMethod")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    schema"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'nm.play.playSongs'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    name"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'playSongs'")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 调用Api")]),a._v("\nmnb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("playSongs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("params"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br")])]),s("h4",{attrs:{id:"准备工作"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#准备工作"}},[a._v("#")]),a._v(" 准备工作")]),a._v(" "),s("ol",[s("li",[s("p",[a._v("引入封装了 JSSDK 的 npm 包。")])]),a._v(" "),s("li",[s("p",[a._v("注册并调用 Api 时，会调用 "),s("code",[a._v("postMessage")])])])]),a._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("postMessage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    className"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    method"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" schema"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    params"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    objectId\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" onSuccess"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" onError"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br")])]),s("ol",{attrs:{start:"3"}},[s("li",[s("p",[s("code",[a._v("postMessage")]),a._v(" 会先进行预处理：")]),a._v(" "),s("ul",[s("li",[a._v("参数合法化")]),a._v(" "),s("li",[a._v("生成调用序列号（前端维护），并保存 “调用的参数” 和 “回调”")])])]),a._v(" "),s("li",[s("p",[a._v("随后，执行客户端调用 "),s("code",[a._v("execute")])]),a._v(" "),s("ul",[s("li",[a._v("iOS（8及以上）："),s("code",[a._v("window.webkit.messageHandlers.WebViewBridge.postMessage")])]),a._v(" "),s("li",[a._v("Android："),s("code",[a._v("window.prompt")])])])])]),a._v(" "),s("blockquote",[s("p",[s("strong",[s("code",[a._v("mnb")]),a._v(" 在不同Native环境，采用不同底层调用方式")])])]),a._v(" "),s("h4",{attrs:{id:"js-sdk启动阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#js-sdk启动阶段"}},[a._v("#")]),a._v(" JS SDK启动阶段")]),a._v(" "),s("ol",[s("li",[a._v("App 启动时，加载 handler 列表")]),a._v(" "),s("li",[a._v("WebView 初始化时，加载 JS SDK")]),a._v(" "),s("li",[a._v("App 在 web页面 加载完成时，注入 "),s("code",[a._v("WebViewBridge")]),a._v("，并通知 JS SDK 连接已建立")]),a._v(" "),s("li",[a._v("JS SDK 创建 Native SDK 运行时需要的上下文对象")])]),a._v(" "),s("h4",{attrs:{id:"js-sdk使用阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#js-sdk使用阶段"}},[a._v("#")]),a._v(" JS SDK使用阶段")]),a._v(" "),s("ol",[s("li",[a._v("JS 调用协议（指定 "),s("code",[a._v("callback")]),a._v("）")]),a._v(" "),s("li",[a._v("JS SDK 生成 "),s("code",[a._v("callbackId")]),a._v("（用于缓存 "),s("code",[a._v("callback")]),a._v(" 的映射）")]),a._v(" "),s("li",[a._v("JS SDK 发起底层通信 "),s("code",[a._v("WebViewBridge.postMessage")])]),a._v(" "),s("li",[a._v("Native SDK收到请求，找到对应 handler 去处理")]),a._v(" "),s("li",[a._v("handler 处理完后回调 JS SDK 结果（包括"),s("code",[a._v("callbackId")]),a._v("、"),s("code",[a._v("result")]),a._v(" 、"),s("code",[a._v("error")]),a._v("）")]),a._v(" "),s("li",[a._v("JS SDK 根据 "),s("code",[a._v("callbackId")]),a._v(" 找到 "),s("code",[a._v("callback")]),a._v("，并传入 "),s("code",[a._v("result")]),a._v("、"),s("code",[a._v("error")]),a._v(" 执行回调")])]),a._v(" "),s("img",{attrs:{src:"https://p5.music.126.net/obj/wo3DlcOGw6DClTvDisK1/7817203514/442b/a449/9afa/80ad78843de506ba0a2f7c5d16e272c0.png",width:"500px"}}),a._v(" "),s("img",{attrs:{src:"https://p5.music.126.net/obj/wo3DlcOGw6DClTvDisK1/7738019941/98ac/8b08/f7db/c6c0c0fcf626b529a2db479a8bde34e5.png",width:"500px"}}),a._v(" "),s("h2",{attrs:{id:"其他"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#其他"}},[a._v("#")]),a._v(" 其他")]),a._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[a._v("TIP")]),a._v(" "),s("p",[a._v("背景")]),a._v(" "),s("h4",{attrs:{id:"scheme注册"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#scheme注册"}},[a._v("#")]),a._v(" Scheme注册")]),a._v(" "),s("p",[a._v("App 安装后会在手机系统上注册一个 "),s("code",[a._v("Scheme")]),a._v("（比如："),s("code",[a._v("weixin://")]),a._v("、"),s("code",[a._v("orpheus://")]),a._v("）。所以在浏览器里访问这个 scheme 地址，系统就会唤起App")]),a._v(" "),s("h4",{attrs:{id:"ios里webview的种类"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ios里webview的种类"}},[a._v("#")]),a._v(" iOS里WebView的种类")]),a._v(" "),s("p",[a._v("iOS 里有 2 种 WebView："),s("code",[a._v("UIWebView")]),a._v("、"),s("code",[a._v("WKWebView")]),a._v("。")]),a._v(" "),s("p",[a._v("其中， "),s("code",[a._v("WKWebView")]),a._v(" 是 iOS8 之后出现的")]),a._v(" "),s("ul",[s("li",[a._v("优点：占用内存更少，能够更好地支持 HTML5，性能更强大")]),a._v(" "),s("li",[a._v("缺点：不支持缓存、需要自己注入Cookie、拦截 Post 请求时无法解析参数")])]),a._v(" "),s("h4",{attrs:{id:"日常中使用jsbridge的产品"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#日常中使用jsbridge的产品"}},[a._v("#")]),a._v(" 日常中使用JSBridge的产品")]),a._v(" "),s("p",[a._v("微信。")]),a._v(" "),s("p",[a._v("微信 给 开发者 提供了 JSSDK，该 SDK 中暴露了很多微信native层的方法（比如支付，定位等）。")])]),a._v(" "),s("h2",{attrs:{id:"参考"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[a._v("#")]),a._v(" 参考")]),a._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://www.zoo.team/article/jsbridge",target:"_blank",rel:"noopener noreferrer"}},[a._v("JSBridge 的起源"),s("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=v.exports}}]);