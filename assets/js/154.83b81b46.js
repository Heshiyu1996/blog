(window.webpackJsonp=window.webpackJsonp||[]).push([[154],{669:function(s,t,a){"use strict";a.r(t);var n=a(46),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"nodejs中的多进程、集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nodejs中的多进程、集群"}},[s._v("#")]),s._v(" NodeJS中的多进程、集群")]),s._v(" "),a("blockquote",[a("p",[a("strong",[s._v("进程是 资源分配 的最小单位，线程是 CPU调度 的最小单位")]),s._v("。")])]),s._v(" "),a("p",[s._v("Node下的js执行环境是单进程、单线程运行（这里的单线程指的是它的JS引擎是单线程），但可以通过"),a("code",[s._v("cluster")]),s._v("或"),a("code",[s._v("child_process")]),s._v("开启 "),a("strong",[s._v("多进程")]),s._v(" 来充分利用多核CPU。")]),s._v(" "),a("h2",{attrs:{id:"child-process"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#child-process"}},[s._v("#")]),s._v(" child_process")]),s._v(" "),a("p",[a("strong",[s._v("Node多进程模式")]),s._v(" 是通过"),a("code",[s._v("child_process")]),s._v("模块可以创建子进程来实现的。")]),s._v(" "),a("p",[s._v("模块里有4种方法（其中后面3个方法基于"),a("code",[s._v("spawn")]),s._v("进行封装）：")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("spawn")])]),s._v(" "),a("li",[a("p",[s._v("fork")])]),s._v(" "),a("li",[a("p",[s._v("execFile")])]),s._v(" "),a("li",[a("p",[s._v("exec")])])]),s._v(" "),a("p",[s._v("以上方法都会返回一个"),a("code",[s._v("childProcess")]),s._v("对象。")]),s._v(" "),a("blockquote",[a("p",[s._v("该对象实现了"),a("code",[s._v("EventEmitter")]),s._v("接口，带有stdout, stdin, stderr对象。")])]),s._v(" "),a("h2",{attrs:{id:"child-process-spawn"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#child-process-spawn"}},[s._v("#")]),s._v(" child_process.spawn")]),s._v(" "),a("p",[s._v("因为"),a("code",[s._v("fork")]),s._v("、"),a("code",[s._v("exec")]),s._v("、"),a("code",[s._v("execFile")]),s._v("都是基于"),a("code",[s._v("spawn")]),s._v("进行的封装，所以"),a("code",[s._v("spawn")]),s._v("是基础。")]),s._v(" "),a("h3",{attrs:{id:"标准进程通信"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#标准进程通信"}},[s._v("#")]),s._v(" 标准进程通信")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// process.js")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" spawn "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'child_process'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("spawn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" path "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"path"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 创建子进程")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" child "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("spawn")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'node'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sub-process.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    cwd"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("__dirname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    stdio"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pipe"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ignore"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ipc"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nchild"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'message'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("data")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 回复消息给子进程")]),s._v("\n    child"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("send")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'world'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 杀死子进程")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// process.kill(child.pid);")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// hello")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// sub-process.js")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 给主进程发送消息")]),s._v("\nprocess"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("send")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hello'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 接收主进程回复的消息")]),s._v("\nprocess"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'message'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("data")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 退出子进程")]),s._v("\n    process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("exit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("这种方式被称为 "),a("strong",[s._v("标准进程通信")]),s._v("。通过给"),a("code",[s._v("options")]),s._v("的"),a("code",[s._v("stdio")]),s._v("数组，配置"),a("code",[s._v("ipc")]),s._v("：")]),s._v(" "),a("ul",[a("li",[s._v("主进程监听"),a("code",[s._v("子进程的message")]),s._v("事件进行接收；在回调中利用"),a("code",[s._v("子进程的send")]),s._v("方法发送消息")]),s._v(" "),a("li",[s._v("子进程监听"),a("code",[s._v("自身的message")]),s._v("事件进行接收；调用"),a("code",[s._v("自身的send")]),s._v("方法发送消息")])]),s._v(" "),a("blockquote",[a("p",[s._v("指定要用message事件")])]),s._v(" "),a("h4",{attrs:{id:"退出、杀死子进程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#退出、杀死子进程"}},[s._v("#")]),s._v(" 退出、杀死子进程")]),s._v(" "),a("p",[s._v("因为子进程在监听"),a("code",[s._v("message")]),s._v("事件时，主进程不知道其什么时候完成，所以主进程会卡住。")]),s._v(" "),a("p",[s._v("此时需要 "),a("strong",[s._v("子进程内退出process.exit()")]),s._v(" 或 "),a("strong",[s._v("主进程杀死process.kill(child.pid)")])]),s._v(" "),a("h3",{attrs:{id:"独立子进程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#独立子进程"}},[s._v("#")]),s._v(" 独立子进程")]),s._v(" "),a("p",[s._v("因为"),a("code",[s._v("child_process")]),s._v("模块创建的子进程是被主进程统一管理的（主进程死，子进程也得死）。")]),s._v(" "),a("p",[s._v("但可以实现子进程的独立：")]),s._v(" "),a("ul",[a("li",[s._v("创建时，在"),a("code",[s._v("options")]),s._v("声明"),a("code",[s._v("detached: true")]),s._v("、"),a("code",[s._v("stdio: 'ignore'")])]),s._v(" "),a("li",[s._v("创建后，执行"),a("code",[s._v("child.unref()")])])]),s._v(" "),a("p",[s._v("缺点："),a("strong",[s._v("独立的子进程不能和主进程进行标准进程通信，即不能设置 ipc。")]),s._v("（不能和主进程共用标准输入、标准输出、错误输出）")]),s._v(" "),a("h2",{attrs:{id:"child-process-fork"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#child-process-fork"}},[s._v("#")]),s._v(" child_process.fork")]),s._v(" "),a("p",[a("code",[s._v("fork")]),s._v("对"),a("code",[s._v("spawn")]),s._v("进行了一层简易的封装：少传了一些默认参数、多了个"),a("code",[s._v("silent")]),s._v("。")]),s._v(" "),a("p",[s._v("实际上返回子进程也是在内部执行"),a("code",[s._v("spawn")]),s._v("后返回。")]),s._v(" "),a("p",[a("strong",[s._v("fork 创建的子进程可以直接通过 send 方法和监听 message 事件与主进程进行通信。")])]),s._v(" "),a("h3",{attrs:{id:"silent"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#silent"}},[s._v("#")]),s._v(" silent")]),s._v(" "),a("p",[a("code",[s._v("silent")]),s._v("实际上是：默认使用"),a("code",[s._v("ipc")]),s._v("通信，以及"),a("code",[s._v("stdio")]),s._v("的两种极端情况：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("silent = true")]),s._v("：将“标准输入、标准输出、错误输出”置为"),a("code",[s._v("ignore")])]),s._v(" "),a("li",[a("code",[s._v("silent = false")]),s._v("：将“标准输入、标准输出、错误输出”置为"),a("code",[s._v("0, 1, 2")])])]),s._v(" "),a("h2",{attrs:{id:"child-process-execfile、child-process-exec"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#child-process-execfile、child-process-exec"}},[s._v("#")]),s._v(" child_process.execFile、child_process.exec")]),s._v(" "),a("p",[a("code",[s._v("execFile")]),s._v("基于"),a("code",[s._v("spawn")]),s._v("封装，可以 "),a("strong",[s._v("创建子进程后，直接进行文件操作")])]),s._v(" "),a("p",[a("code",[s._v("exec")]),s._v("基于"),a("code",[s._v("execFile")]),s._v("封装，可以 "),a("strong",[s._v("创建子进程后，直接执行命令")])]),s._v(" "),a("blockquote",[a("p",[a("code",[s._v("exec")]),s._v("常见场景："),a("code",[s._v("webpack-dev-server")]),s._v("等命令行工具在启动本地服务器时，自己打开浏览器")])]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" execFile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" exec "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"child_process"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" execFileChild "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("execFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--version"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" stdout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" stderr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" error"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("stdout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("stderr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" execChild "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("exec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"node --version"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" stdout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" stderr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throw")]),s._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("stdout"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("stderr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("区别：传参。")]),s._v(" "),a("h2",{attrs:{id:"cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cluster"}},[s._v("#")]),s._v(" cluster")]),s._v(" "),a("p",[a("code",[s._v("cluster")]),s._v("是NodeJS提供用来 "),a("strong",[s._v("实现多进程")]),s._v(" 的模块，它集成了 "),a("code",[s._v("child_process")]),s._v(" 创建子进程的方法（比 "),a("code",[s._v("ipc")]),s._v(" 更加简洁）。")]),s._v(" "),a("h3",{attrs:{id:"通过cluster实现集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#通过cluster实现集群"}},[s._v("#")]),s._v(" 通过cluster实现集群")]),s._v(" "),a("p",[a("code",[s._v("集群")]),s._v("指的是，"),a("strong",[s._v("负责接收并响应请求的多台服务器的集合。")])]),s._v(" "),a("p",[s._v("NodeJS是 "),a("strong",[s._v("通过创建多进程")]),s._v(" 来实现集群的。")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" cluster "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" http "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" os "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"os"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 判断当前执行的进程是否为主进程：")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 主进程：创建子进程")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 子进程：监听服务")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cluster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("isMaster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 创建子进程")]),s._v("\n    os"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cpus")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("forEach")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" cluster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 创建并监听服务")]),s._v("\n    http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("createServer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[s._v("req"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" res")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        res"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("child")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[s._v("${")]),s._v("process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("pid"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[s._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[s._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("ul",[a("li",[s._v("主进程执行时，会通过"),a("code",[s._v("cluster.fork()")]),s._v("创建子进程")]),s._v(" "),a("li",[s._v("子进程被创建后，该文件会再次执行（但此时"),a("code",[s._v("cluster.isMaster为false")]),s._v("），开始创建并监听服务。")])]),s._v(" "),a("h3",{attrs:{id:"多个进程为什么可以监听同一个端口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#多个进程为什么可以监听同一个端口"}},[s._v("#")]),s._v(" 多个进程为什么可以监听同一个端口？")]),s._v(" "),a("p",[a("strong",[s._v("理论上不允许，会出现端口冲突。")])]),s._v(" "),a("p",[a("strong",[s._v("实际上，端口只会被 主进程 绑定监听一次。")]),s._v(" 然后在和子进程建立IPC通道后，会通过子进程的"),a("code",[s._v("send方法")]),s._v("将"),a("code",[s._v("Socket")]),s._v("（也就是"),a("code",[s._v("server")]),s._v("）传给子进程实现 "),a("strong",[s._v("端口共享")]),s._v("。")]),s._v(" "),a("p",[s._v("当接收到请求后，主进程 会通过 "),a("strong",[s._v("负载均衡")]),s._v(" 来分配请求到各个子进程中。")]),s._v(" "),a("h3",{attrs:{id:"多个进程间的通信"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#多个进程间的通信"}},[s._v("#")]),s._v(" 多个进程间的通信？")]),s._v(" "),a("p",[s._v("进程间通信有几种：pipe（管道）、消息队列、信号量、Domain Socket。")]),s._v(" "),a("p",[s._v("在NodeJS中，是通过"),a("code",[s._v("pipe")]),s._v("实现进程间的通信的。(将一个进程的输出做为另外一个进程的输入)")]),s._v(" "),a("p",[a("strong",[s._v("好处：")])]),s._v(" "),a("ul",[a("li",[s._v("进程通信比较简单")]),s._v(" "),a("li",[s._v("减少端口的资源浪费")]),s._v(" "),a("li",[s._v("对 主进程 稳定性要求高")])]),s._v(" "),a("h4",{attrs:{id:"常用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常用场景"}},[s._v("#")]),s._v(" 常用场景")]),s._v(" "),a("p",[s._v("pm2")]),s._v(" "),a("h2",{attrs:{id:"nodejs的单线程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nodejs的单线程"}},[s._v("#")]),s._v(" NodeJS的单线程")]),s._v(" "),a("p",[s._v("NodeJS下的JS执行环境是单线程的，只是通过"),a("code",[s._v("cluster")]),s._v("/"),a("code",[s._v("child_process")]),s._v("提供了一个通过"),a("strong",[s._v("创建多进程来模拟多线程")]),s._v("的方式。")]),s._v(" "),a("p",[a("code",[s._v("Node v10.5.0")]),s._v("提出了一个概念 "),a("strong",[s._v("worker_threads")]),s._v("，可以让NodeJS具有多线程的能力。")]),s._v(" "),a("h2",{attrs:{id:"参考链接"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考链接"}},[s._v("#")]),s._v(" 参考链接")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://juejin.im/post/5bbd83f5e51d450e894e4f3a#heading-7",target:"_blank",rel:"noopener noreferrer"}},[s._v("NodeJS中的多进程、集群"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/112597848",target:"_blank",rel:"noopener noreferrer"}},[s._v("Nodejs 进阶：解答 Cluster 模块的几个疑问"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s/dKN95zcRI7qkwGYKhPXrcg",target:"_blank",rel:"noopener noreferrer"}},[s._v("10道Nodejs进程相关"),a("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=e.exports}}]);