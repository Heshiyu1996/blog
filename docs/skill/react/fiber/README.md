# React Fiber
> Fiberæ˜¯React16ä¸­æ–°çš„åè°ƒå¼•æ“ã€‚
>
> å®ƒçš„ä¸»è¦ç›®çš„æ˜¯ä½¿Vitrual DOMå¯ä»¥è¿›è¡Œå¢é‡å¼çš„æ¸²æŸ“ï¼ˆæ¥è‡ªReactå®˜æ–¹æ–‡æ¡£ï¼‰ã€‚
>
> update: 2020-1-3

[[toc]]

## æµè§ˆå™¨é‡Œçš„â€œå•å¤„ç†å™¨è°ƒåº¦â€
[å¤ä¹ å•å¤„ç†å™¨è°ƒåº¦ç­–ç•¥](./../../computeracy/scheduling-strategy/)

æˆ‘ä»¬å¯ä»¥**æŠŠæµè§ˆå™¨ä¸­JavaScriptæ‰§è¡Œç¯å¢ƒï¼ˆå³Rendererè¿›ç¨‹ï¼‰å½“ä½œæ˜¯ä¸€å°å•å¤„ç†å™¨**ã€‚

æ‰“å¼€Chrome-ä»»åŠ¡ç®¡ç†å™¨ï¼Œå¯ä»¥å‘ç°ï¼š
![alt](./img/fiber-3.png)

1ã€æµè§ˆå™¨æ˜¯**å¤šè¿›ç¨‹**çš„ï¼Œä¸”å…¶ä¸‹å„ä¸ªè¿›ç¨‹çš„èŒè´£å¦‚ä¸‹ï¼š
```
ä¸»è¿›ç¨‹ï¼ˆBrowserè¿›ç¨‹ï¼‰ï¼š
    - æµè§ˆå™¨çš„ç•Œé¢äº¤äº’ï¼ˆå‰è¿›ã€åé€€ç­‰ï¼‰
    - è´Ÿè´£å„ä¸ªé¡µé¢çš„ç®¡ç†ï¼ˆåˆ›å»ºã€é”€æ¯å…¶å®ƒè¿›ç¨‹ï¼‰
    - å°†Rendererè¿›ç¨‹å¾—åˆ°çš„å†…å­˜ä¸­çš„Bitmapï¼Œç»˜åˆ¶åˆ°ç•Œé¢ä¸Š
    - é™æ€èµ„æºä¸‹è½½

æµè§ˆå™¨å†…æ ¸ï¼ˆRendererè¿›ç¨‹ï¼‰ï¼š
    - JSå¼•æ“çº¿ç¨‹ï¼šJSè§£æå’Œæ‰§è¡Œ
    - GUIæ¸²æŸ“çº¿ç¨‹ï¼šå¸ƒå±€/ç»˜åˆ¶
    - äº‹ä»¶è§¦å‘çº¿ç¨‹ï¼šäº‹ä»¶å¤„ç†

GPUè¿›ç¨‹ï¼šæœ€å¤šä¸€ä¸ªï¼Œç”¨äº3Dç»˜åˆ¶ç­‰

ç¬¬ä¸‰æ–¹æ’ä»¶è¿›ç¨‹ï¼šæ¯ç§ç±»å‹çš„è°·æ­Œæµè§ˆå™¨æ’ä»¶å¯¹åº”ä¸€ä¸ªè¿›ç¨‹ï¼Œä»…å½“ä½¿ç”¨äº†è¯¥æ’ä»¶æ—¶æ‰åˆ›å»º
```
> "Browserè¿›ç¨‹"å’Œ"Rendererè¿›ç¨‹"ä¹‹é—´å¯ä»¥é€šè¿‡ `RendererHostæ¥å£` å–å¾—è”ç³»ã€‚

2ã€JSå¼•æ“æ˜¯**å•çº¿ç¨‹è¿è¡Œ**ï¼ˆåœ¨Rendererè¿›ç¨‹ä¸‹ï¼‰ï¼›

3ã€JSå¼•æ“çº¿ç¨‹ã€GUIæ¸²æŸ“çº¿ç¨‹**äº’æ–¥**ï¼›

4ã€å¦‚æœ**JSå¼•æ“ä¸­çš„æŸä¸ªä»»åŠ¡**é•¿æœŸéœ¸å CPUï¼Œæµè§ˆå™¨ä¼šå‡ºç°å¡æ­»çŠ¶æ€ã€‚

### å¯¹äºå‰ç«¯æ¡†æ¶ï¼Œâ€œè§£å†³å¡æ­»â€æœ‰ä¸‰ç§æ€è·¯:
 - **ä¼˜åŒ–JSå¼•æ“ä¸­çš„æ¯ä¸ªä»»åŠ¡ã€‚**
    > Vueä½¿ç”¨çš„æ˜¯è¿™ç§ã€‚å› ä¸ºå“åº”å¼æœºåˆ¶å¯ä»¥è®©Vueæ›´ç²¾ç¡®åœ°è¿›è¡ŒèŠ‚ç‚¹æ›´æ–°ã€‚

 - **å¿«é€Ÿå“åº”ç”¨æˆ·ï¼Œä¸é˜»å¡ç”¨æˆ·çš„äº¤äº’**
    > Reactä½¿ç”¨çš„æ˜¯è¿™ç§ï¼Œæ‰€ä»¥å¼•å…¥äº†Fiberæ¶æ„ã€‚

 - **å°è¯•Workerå¤šçº¿ç¨‹**
    > ä¿è¯çŠ¶æ€å’Œè§†å›¾çš„ä¸€è‡´æ€§å¾ˆéº»çƒ¦ã€‚Workerç›¸å½“äºJSå¼•æ“å‘æµè§ˆå™¨ç”³è¯·å¼€ä¸€ä¸ªworkerçº¿ç¨‹ã€‚"JSå¼•æ“çº¿ç¨‹"å’Œ"workerçº¿ç¨‹"ä¹‹é—´é€šè¿‡ç‰¹å®šæ–¹å¼é€šä¿¡ï¼ˆä½†workerçº¿ç¨‹å®Œå…¨å—æ§äºä¸»çº¿ç¨‹ï¼Œè€Œä¸”ä¸èƒ½æ“ä½œDOMï¼ŒJSå¼•æ“ä¾ç„¶æ˜¯å•çº¿ç¨‹çš„ï¼‰ã€‚

## ä»¥å‰çš„Reconciliationä¸å¯ä¸­æ–­ï¼ï¼ˆğŸ¤”å¼•å…¥Fiberçš„åŸå› ï¼‰
**é€šè¿‡æ¯”è¾ƒæ–°ã€æ—§Virtual DOMæ ‘æ¥æ‰¾å‡ºå˜åŠ¨äº†çš„èŠ‚ç‚¹ï¼Œç„¶ååŒæ­¥æ›´æ–°å®ƒä»¬ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºReconciliationï¼ˆåè°ƒï¼‰**ã€‚
> Reconciliationæ˜¯CPUå¯†é›†å‹æ“ä½œï¼Œç›¸å½“äºâ€œé•¿è¿›ç¨‹â€ã€‚
> 
> ç±»æ¯”â€œè¿›ç¨‹è°ƒåº¦â€ï¼Œæˆ‘ä»¬åº”è¯¥è®©é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹ï¼ˆæˆ–è€…çŸ­è¿›ç¨‹ï¼‰å…ˆè¿è¡Œï¼Œä¸èƒ½è®©é•¿è¿›ç¨‹é•¿æœŸéœ¸å èµ„æºã€‚

### å¼•å…¥Fiberå‰
å› ä¸º**Reconciliationä¸å¯ä¸­æ–­**ï¼Œæ‰€ä»¥Reactä¼šéœ¸å ç€**JSå¼•æ“çº¿ç¨‹**ï¼Œå¾ˆå¯èƒ½ä¼šå¯¼è‡´ç”¨æˆ·**å¾—ä¸åˆ°å“åº”**æˆ–**å¡é¡¿**ã€‚
> åŸå› ï¼šJSå¼•æ“çº¿ç¨‹ã€GUIæ¸²æŸ“çº¿ç¨‹**äº’æ–¥**ã€‚

### å¼•å…¥Fiberå
**Fiberæ˜¯React 16ä¸­æ–°çš„åè°ƒå¼•æ“**ã€‚
> å®ƒå¯ä»¥**ä½¿Reconciliationè¿‡ç¨‹å˜æˆå¯ä¸­æ–­**ï¼Œâ€œé€‚æ—¶â€åœ°è®©å‡ºCPUæ‰§è¡Œæƒã€‚

å¥½å¤„ï¼š
 - è®©æµè§ˆå™¨åŠæ—¶å“åº”äº¤äº’
 - åˆ†æ‰¹å»¶æ—¶å¯¹DOMè¿›è¡Œæ“ä½œ
 - ä½¿æµè§ˆå™¨ä¼šå¯¹ä»£ç è¿›è¡Œç¼–è¯‘ä¼˜åŒ–ï¼ˆJITï¼‰åŠè¿›è¡Œçƒ­ä»£ç ä¼˜åŒ–ï¼Œæˆ–è€…å¯¹reflowè¿›è¡Œä¿®æ­£ï¼ˆï¼Ÿï¼‰


é‚£å®ƒæ˜¯å¦‚ä½•ä½¿Reconciliationå˜å¾—å¯ä¸­æ–­çš„å‘¢ï¼Ÿ

## ä»€ä¹ˆæ˜¯Fiber
Fiberçš„æ€æƒ³ï¼š**å¯ä»¥ä¸­æ–­Reactçš„æ¸²æŸ“è¿‡ç¨‹ã€‚ä¸­æ–­åReactä¼šä¸»åŠ¨å°†æ§åˆ¶æƒäº¤å›æµè§ˆå™¨ï¼Œè®©ä½ç»™é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œç­‰åˆ°æµè§ˆå™¨ç©ºé—²åå†æ¢å¤æ¸²æŸ“ã€‚**

### è®©å‡ºæ§åˆ¶æƒæœ‰å“ªäº›éœ€è¦æ³¨æ„çš„ï¼Ÿ
2ä¸ªå…³é”®ç‚¹ï¼š
 - å¦‚ä½•**ä¸»åŠ¨å½’è¿˜æ§åˆ¶æƒ**ï¼ŸğŸ˜†
 - **ä»€ä¹ˆæ—¶å€™**å½’è¿˜ï¼Ÿâ°

#### 1ã€ä¸»åŠ¨å½’è¿˜æ§åˆ¶æƒ
å› ä¸ºæµè§ˆå™¨æ²¡æœ‰æŠ¢å æœºåˆ¶ï¼Œæ‰€ä»¥è¦é‡‡ç”¨**åˆä½œå¼è°ƒåº¦ï¼ˆCooperative Schedulingï¼‰æœºåˆ¶**ã€‚
 > ä¸â€œåˆä½œå¼è°ƒåº¦â€ç›¸åçš„æ˜¯â€œæŠ¢å å¼è°ƒåº¦â€ï¼ˆPreemptive Schedulingï¼‰

![alt](./img/fiber-1.png)

**åˆä½œå¼è°ƒåº¦æœºåˆ¶**çš„å¤§è‡´æ€æƒ³ï¼š

**Reactå‘æµè§ˆå™¨ç”³è¯·ä¸€ä¸ªâ€œæœ‰æœŸé™çš„æ‰§è¡Œæƒâ€ï¼›ï¼ˆç”³è¯·æ—¶é—´ç‰‡ï¼‰**

â¡ï¸ **æµè§ˆå™¨åœ¨æ¯å¸§å†…æ‰§è¡Œå®Œä»»åŠ¡ï¼ˆä¸€èˆ¬æ˜¯â€œç»˜åˆ¶â€ï¼‰åï¼Œä¼šæ‰§è¡Œâ€œä¼ è¿‡æ¥çš„å›è°ƒâ€ï¼Œå‘Šè¯‰Reactèƒ½å€Ÿå¤šé•¿æ—¶é—´ï¼›**

â¡ï¸ **å€Ÿå®ŒåReactè¦æŒ‰ç…§çº¦å®šï¼Œâ€œä¸»åŠ¨â€å½’è¿˜æ§åˆ¶æƒç»™æµè§ˆå™¨**ã€‚
 > å½“ç„¶è¶…æ—¶ä¸è¿˜ï¼Œæµè§ˆå™¨ä¹Ÿæ˜¯æ²¡åŠæ³•çš„ğŸ¤·â€â™‚ï¸ã€‚å…¨å‡­è‡ªå¾‹ï¼Œäº’ç›¸ä¿¡ä»»ã€‚


#### 2ã€ä»€ä¹ˆæ—¶å€™å½’è¿˜ï¼Ÿ
å› ä¸ºåœ¨æµè§ˆå™¨ä¸­æ²¡åŠæ³•åˆ¤æ–­åé¢æ˜¯å¦æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œæ‰€ä»¥è¦é€šè¿‡**è¶…æ—¶æ£€æŸ¥çš„æœºåˆ¶**æ¥å½’è¿˜æ§åˆ¶æƒã€‚

**è¶…æ—¶æ£€æŸ¥çš„æœºåˆ¶**çš„å¤§è‡´æ€æƒ³ï¼š

**ç»™Reactç¡®å®šä¸€ä¸ªæ—¶é—´èŒƒå›´ï¼ˆè§ä¸‹æ–‡ï¼‰ï¼Œç„¶åReactåœ¨æ¯æ‰§è¡Œå®Œä¸€ä¸ªå°ä»»åŠ¡åæ£€æŸ¥æ˜¯å¦è¶…æ—¶ã€‚**

â¡ï¸ **è‹¥è¶…æ—¶å°±åœæ­¢æ‰§è¡Œï¼Œå°†æ§åˆ¶æƒå½’è¿˜ç»™æµè§ˆå™¨ã€‚**

##### é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè¿™ä¸ªæ—¶é—´èŒƒå›´æ€ä¹ˆç¡®å®šå‘¢ï¼Ÿâ°
å› ä¸ºæµè§ˆå™¨ï¼ˆä¸¥æ ¼è¯´æ˜¯Rendererè¿›ç¨‹ï¼‰åœ¨ä¸€å¸§ï¼ˆå³ä¸€ä¸ªæ—¶é—´ç‰‡ï¼‰å†…å¯èƒ½ä¼šæ‰§è¡Œä¸‹åˆ—ä»»åŠ¡ï¼ˆæ‰§è¡Œé¡ºåºåŸºæœ¬å›ºå®šï¼‰ï¼š
 - å¤„ç†ç”¨æˆ·è¾“å…¥äº‹ä»¶ï¼ˆäº‹ä»¶è§¦å‘çº¿ç¨‹ï¼‰
 - JSæ‰§è¡Œï¼ˆJSå¼•æ“çº¿ç¨‹ï¼‰
 - requestAnimationè°ƒç”¨
 - å¸ƒå±€Layoutï¼ˆGUIæ¸²æŸ“çº¿ç¨‹ï¼‰
 - ç»˜åˆ¶Paintï¼ˆGUIæ¸²æŸ“çº¿ç¨‹ï¼‰
 
 > ç†æƒ³æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ—¶é—´ç‰‡åº”è¯¥åˆ’åˆ†ä¸º16msï¼Œå› ä¸ºäººç±»èƒ½æ„ŸçŸ¥åˆ°æœ€ä½é™åº¦çš„é¢‘ç‡æ˜¯æ¯ç§’60å¸§ï¼ˆ1000ms / 60 = 16 msï¼‰ã€‚

åœ¨æ¯ä¸ªæ—¶é—´ç‰‡å†…ï¼Œå¦‚æœæµè§ˆå™¨åœ¨æ‰§è¡Œå®Œä¸Šé¢çš„ä»»åŠ¡åè¿˜æœ‰å‰©ä½™æ—¶é—´ï¼Œå°±ä¼šè°ƒç”¨å¾€`requestIdleCallback`ä¸­ä¼ å…¥çš„å›è°ƒã€‚

![alt](./img/fiber-2.png)

`requestIdleCallback`APIï¼š
```js
window.requestIdleCallback(
    // æµè§ˆå™¨åœ¨ç©ºé—²æ—¶ï¼Œä¼šæ‰§è¡Œè¿™ä¸ªå›è°ƒï¼ŒåŒæ—¶ä¼šç»™å›è°ƒä¼ å…¥ä¸€ä¸ªdealineå¯¹è±¡
    // åœ¨dealineå¯¹è±¡ä¸­åŒ…å«ç€æµè§ˆå™¨ç›®å‰æœ‰å¤šå°‘æ—¶é—´ä¾›æˆ‘ä»¬æ‰§è¡Œ
    callback: (dealine: IdleDeadline) => void,
    // ä¸ºäº†é¿å…æµè§ˆå™¨å› ç¹å¿™ä¸”æ— å‰©ä½™æ—¶é—´å¯¼è‡´çš„é¥¿æ­»ï¼Œå¯ä¼ å…¥ä¸€ä¸ªè¶…æ—¶æ—¶é—´æ¥å¼ºåˆ¶è®©æµè§ˆå™¨æ‰§è¡Œå›è°ƒã€‚
    option?: { timeout: number }
)
```

`IdleDeadline`æ¥å£ï¼š
```js
interface IdleDealine {
    didTimeout: boolean // è¡¨ç¤ºä»»åŠ¡æ‰§è¡Œæ˜¯å¦è¶…è¿‡çº¦å®šæ—¶é—´
    timeRemaining(): DOMHighResTimeStamp // ä»»åŠ¡å¯ä¾›æ‰§è¡Œçš„å‰©ä½™æ—¶é—´
}
```

ç›®å‰`requestIdCallback`åªæœ‰Chromeæ”¯æŒã€‚Reactè‡ªå·±å®ç°äº†ä¸€ä¸ªï¼ˆåˆ©ç”¨`MessageChannel`å°†å›è°ƒå»¶è¿Ÿåˆ°â€œç»˜åˆ¶Paintâ€ä¹‹åæ‰§è¡Œï¼‰[æŸ¥çœ‹æºç ](https://github.com/facebook/react/blob/master/packages/scheduler/src/forks/SchedulerHostConfig.default.js)

å¦å¤–ï¼Œå¯¹äº`option`è¿™ä¸ªå‚æ•°æ‰€å®šä¹‰çš„**è¶…æ—¶æ—¶é—´å¹¶**ä¸æ˜¯å›ºå®š**çš„ã€‚
> ä½ä¼˜å…ˆçº§å¯ä»¥æ…¢æ…¢ç­‰å¾…ï¼Œé«˜ä¼˜å…ˆçº§åº”è¯¥å…ˆè¢«æ‰§è¡Œ
```
ç›®å‰Reacté¢„å®šä¹‰äº†5ä¸ªä¼˜å…ˆçº§ï¼š
 - Immediate(-1)
 - UserBlocking(250ms)
 - Normal(5s)
 - Low(10s)
 - Idle(æ²¡æœ‰è¶…æ—¶æ—¶é—´)
```











## å‚è€ƒé“¾æ¥

- [Virtual DOM åŠå†…æ ¸](https://zh-hans.reactjs.org/docs/faq-internals.html#what-is-react-fiber)

- [è¿™å¯èƒ½æ˜¯æœ€é€šä¿—çš„ React Fiber(æ—¶é—´åˆ†ç‰‡) æ‰“å¼€æ–¹å¼](https://juejin.im/post/5dadc6045188255a270a0f85#heading-2)