# React Fiber
> Fiberæ˜¯React16ä¸­æ–°çš„åè°ƒå¼•æ“ã€‚
>
> å®ƒçš„ä¸»è¦ç›®çš„æ˜¯ä½¿Vitrual DOMå¯ä»¥è¿›è¡Œå¢é‡å¼çš„æ¸²æŸ“ï¼ˆæ¥è‡ªReactå®˜æ–¹æ–‡æ¡£ï¼‰ã€‚
>
> update: 2020-1-3

[[toc]]

## æµè§ˆå™¨é‡Œçš„â€œå•å¤„ç†å™¨è°ƒåº¦â€
[å¤ä¹ å•å¤„ç†å™¨è°ƒåº¦ç­–ç•¥](./../../computeracy/scheduling-strategy/)

æˆ‘ä»¬å¯ä»¥**æŠŠæµè§ˆå™¨ä¸­JavaScriptæ‰§è¡Œç¯å¢ƒå½“ä½œæ˜¯ä¸€å°å•å¤„ç†å™¨**ã€‚

1ã€JSå¼•æ“æ˜¯å•çº¿ç¨‹è¿è¡Œçš„ï¼›

2ã€JSå¼•æ“ã€æ¸²æŸ“å¼•æ“åœ¨åŒä¸€ä¸ªæ¸²æŸ“çº¿ç¨‹ï¼›

3ã€æµè§ˆå™¨éœ€è¦è´Ÿè´£é¡µé¢çš„ï¼š**JSè§£æå’Œæ‰§è¡Œã€ç»˜åˆ¶ã€äº‹ä»¶å¤„ç†ã€é™æ€èµ„æºåŠ è½½å’Œå¤„ç†ç­‰ç­‰**ï¼›
> è¿™äº›ä»»åŠ¡å¯ä»¥ç±»æ¯”æˆâ€œä¸€ä¸ªä¸ªè¿›ç¨‹â€

4ã€å¦‚æœæŸä¸ªä»»åŠ¡é•¿æœŸéœ¸å CPUï¼Œæµè§ˆå™¨ä¼šå‡ºç°å¡æ­»çŠ¶æ€ã€‚

---

å¯¹äºå‰ç«¯æ¡†æ¶ï¼Œâ€œè§£å†³å¡æ­»â€æœ‰ä¸‰ä¸ªæ–¹å‘:
 - ä¼˜åŒ–æ¯ä¸ªä»»åŠ¡ï¼Œè®©å®ƒæœ‰å¤šå¿«å°±å¤šå¿«ï¼ŒæŒ¤å‹CPUè¿ç®—é‡
    > Vueä½¿ç”¨çš„æ˜¯è¿™ç§ã€‚å› ä¸ºå“åº”å¼æœºåˆ¶å¯ä»¥è®©Vueæ›´ç²¾ç¡®åœ°è¿›è¡ŒèŠ‚ç‚¹æ›´æ–°ã€‚

 - å¿«é€Ÿå“åº”ç”¨æˆ·ï¼Œä¸é˜»å¡ç”¨æˆ·çš„äº¤äº’
    > Reactä½¿ç”¨çš„æ˜¯è¿™ç§ï¼Œæ‰€ä»¥å¼•å…¥äº†Fiberæ¶æ„ã€‚

 - å°è¯•Workerå¤šçº¿ç¨‹
    > ä¿è¯çŠ¶æ€å’Œè§†å›¾çš„ä¸€è‡´æ€§å¾ˆéº»çƒ¦ã€‚

## ä»¥å‰çš„Reconciliationä¸å¯ä¸­æ–­ï¼ï¼ˆå¼•å…¥Fiberçš„åŸå› ï¼‰
**é€šè¿‡æ¯”è¾ƒVirtual DOMæ ‘çš„å˜åŒ–ï¼Œæ‰¾å‡ºéœ€è¦å˜åŠ¨çš„èŠ‚ç‚¹ï¼Œç„¶ååŒæ­¥æ›´æ–°å®ƒä»¬ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºReconciliationï¼ˆåè°ƒï¼‰**ã€‚
> Reconciliationæ˜¯CPUå¯†é›†å‹æ“ä½œï¼Œç›¸å½“äºâ€œé•¿è¿›ç¨‹â€ã€‚å’Œè¿›ç¨‹è°ƒåº¦çš„æ€æƒ³ä¸€æ ·ï¼Œæˆ‘ä»¬åº”è¯¥è®©é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹ï¼ˆæˆ–è€…çŸ­è¿›ç¨‹ä¼˜ï¼‰å…ˆè¿è¡Œï¼Œä¸èƒ½è®©é•¿è¿›ç¨‹é•¿æœŸéœ¸å èµ„æºã€‚

### å¼•å…¥Fiberå‰
å› ä¸ºReconciliationä¸å¯ä¸­æ–­ï¼Œæ‰€ä»¥Reactä¼šéœ¸å ç€æµè§ˆå™¨èµ„æºï¼Œå¾ˆå¯èƒ½ä¼šå¯¼è‡´ç”¨æˆ·äº¤äº’å¾—ä¸åˆ°å“åº”ï¼Œæˆ–è€…æ‰å¸§ï¼ˆç”¨æˆ·æ„ŸçŸ¥åˆ°å¡é¡¿ï¼‰ã€‚

### å¼•å…¥Fiberå
Reacté€šè¿‡Fiberæ¶æ„ï¼Œè®©è‡ªå·±çš„Reconciliationè¿‡ç¨‹å˜æˆå¯ä¸­æ–­ï¼Œâ€œé€‚æ—¶â€åœ°è®©å‡ºCPUæ‰§è¡Œæƒï¼Œä»–çš„å¥½å¤„æ˜¯ï¼š
 - è®©æµè§ˆå™¨åŠæ—¶å“åº”äº¤äº’
 - åˆ†æ‰¹å»¶æ—¶å¯¹DOMè¿›è¡Œæ“ä½œ
 - ç»™æµè§ˆå™¨ä¸€ç‚¹å–˜æ¯çš„æœºä¼šï¼Œä»–ä¼šå¯¹ä»£ç è¿›è¡Œç¼–è¯‘ä¼˜åŒ–ï¼ˆJITï¼‰åŠè¿›è¡Œçƒ­ä»£ç ä¼˜åŒ–ï¼Œæˆ–è€…å¯¹reflowè¿›è¡Œä¿®æ­£

æ‰€ä»¥è¯´ï¼Œ**Fiberæ˜¯React 16ä¸­æ–°çš„åè°ƒå¼•æ“**ã€‚

é‚£å®ƒæ˜¯å¦‚ä½•ä½¿Reconciliationå˜å¾—å¯ä¸­æ–­çš„å‘¢ï¼Ÿ

## ä»€ä¹ˆæ˜¯Fiber
React Fiberçš„æ€æƒ³ï¼š**Reactæ¸²æŸ“çš„è¿‡ç¨‹å¯ä»¥è¢«ä¸­æ–­ã€‚ä¸­æ–­åReactä¼šä¸»åŠ¨å°†æ§åˆ¶æƒäº¤å›æµè§ˆå™¨ï¼Œè®©ä½ç»™é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œç­‰åˆ°æµè§ˆå™¨ç©ºé—²åå†æ¢å¤æ¸²æŸ“ã€‚**

----

è®©å‡ºæ§åˆ¶æƒçš„2ä¸ªå…³é”®ç‚¹ï¼š**1ã€ä¸»åŠ¨å½’è¿˜æ§åˆ¶æƒï¼›2ã€ä»€ä¹ˆæ—¶å€™ä¼šæœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆä»€ä¹ˆæ—¶å€™å½’è¿˜ï¼‰ï¼Ÿ**

#### 1ã€ğŸ˜†ä¸»åŠ¨å½’è¿˜æ§åˆ¶æƒ
å› ä¸ºæµè§ˆå™¨æ²¡æœ‰æŠ¢å æœºåˆ¶ï¼Œæ‰€ä»¥é‡‡ç”¨çš„æ˜¯**åˆä½œå¼è°ƒåº¦ï¼ˆCooperative Schedulingï¼‰æœºåˆ¶**ã€‚
 > ä¸â€œåˆä½œå¼è°ƒåº¦â€ç›¸åçš„æ˜¯â€œæŠ¢å å¼è°ƒåº¦â€ï¼ˆPreemptive Schedulingï¼‰

![alt](./img/fiber-1.png)

è¿™ç§æœºåˆ¶å¤§è‡´æ˜¯ï¼š

**Reactå‘æµè§ˆå™¨ç”³è¯·ä¸€ä¸ªâ€œæœ‰æœŸé™çš„æ‰§è¡Œæƒâ€ï¼›ï¼ˆç”³è¯·æ—¶é—´ç‰‡ï¼‰**

â¡ï¸ **æµè§ˆå™¨ä¼šåœ¨æ¯å¸§å†…æ‰§è¡Œå®Œâ€œæœ€åçš„ç»˜åˆ¶Paintä»»åŠ¡â€åï¼Œä¼šæ‰§è¡Œä¼ è¿‡æ¥çš„å›è°ƒå‘Šè¯‰Reactèƒ½å€Ÿå¤šé•¿æ—¶é—´ï¼›**

â¡ï¸ **å€Ÿå®ŒåReactè¦æŒ‰ç…§çº¦å®šâ€œä¸»åŠ¨â€å½’è¿˜ç»™æµè§ˆå™¨**ã€‚
 > å½“ç„¶è¶…æ—¶ä¸è¿˜ï¼Œæµè§ˆå™¨ä¹Ÿæ²¡åŠæ³•ğŸ¤·â€â™‚ï¸ã€‚å…¨å‡­è‡ªå¾‹ï¼Œäº’ç›¸ä¿¡ä»»ã€‚


#### 2ã€â°ä»€ä¹ˆæ—¶å€™å½’è¿˜ï¼Ÿ
å› ä¸ºåœ¨æµè§ˆå™¨ä¸­**æ²¡åŠæ³•åˆ¤æ–­å½“å‰æ˜¯å¦æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡åœ¨åé¢ç­‰å¾…**ï¼Œæ‰€ä»¥é‡‡ç”¨çš„æ˜¯**é€šè¿‡è¶…æ—¶æ£€æŸ¥çš„æœºåˆ¶æ¥å½’è¿˜æ§åˆ¶æƒ**ã€‚

è¿™ç§æœºåˆ¶å¤§è‡´æ˜¯ï¼Œ**ç»™Reactä¸€ä¸ªæ—¶é—´èŒƒå›´ï¼Œç„¶åReactåœ¨æ¯æ‰§è¡Œå®Œä¸€ä¸ªå°ä»»åŠ¡åæ£€æŸ¥æ˜¯å¦è¶…æ—¶ã€‚è‹¥è¶…æ—¶å°±åœæ­¢æ‰§è¡Œï¼Œå°†æ§åˆ¶æƒå½’è¿˜ç»™æµè§ˆå™¨ã€‚**

â°â°â°
é—®é¢˜æ¥äº†ï¼Œ**é‚£è¿™ä¸ªæ—¶é—´èŒƒå›´æ€ä¹ˆç¡®å®šå‘¢ï¼Ÿ** 
â°â°â°

å·²çŸ¥æµè§ˆå™¨åœ¨ä¸€å¸§ï¼ˆå³ä¸€ä¸ªæ—¶é—´ç‰‡ï¼‰å†…å¯èƒ½ä¼šæ‰§è¡Œä¸‹åˆ—ä»»åŠ¡ï¼ˆæ‰§è¡Œé¡ºåºåŸºæœ¬å›ºå®šï¼‰ï¼š
 - å¤„ç†ç”¨æˆ·è¾“å…¥äº‹ä»¶
 - JSæ‰§è¡Œ
 - requestAnimationè°ƒç”¨
 - å¸ƒå±€Layout
 - ç»˜åˆ¶Paint
 
 > ç†æƒ³æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ—¶é—´ç‰‡åº”è¯¥åˆ’åˆ†ä¸º16msã€‚å› ä¸ºäººç±»èƒ½æ„ŸçŸ¥åˆ°æœ€ä½é™åº¦çš„é¢‘ç‡æ˜¯æ¯ç§’60å¸§ï¼ˆ1000ms / 60 = 16 msï¼‰ï¼Œè§†å›¾â€œå˜å¾—â€æµç•…åœ°è¿è¡Œã€‚

å½“æ¯ä¸ªæ—¶é—´ç‰‡å†…ï¼Œå¦‚æœæµè§ˆå™¨æ‰§è¡Œå®Œä¸Šé¢çš„ä»»åŠ¡åï¼Œè¿˜æœ‰å‰©ä½™æ—¶é—´ï¼Œå°±ä¼šè°ƒç”¨`requestIdleCallback`ä¸­ä¼ å…¥çš„å›è°ƒã€‚

![alt](./img/fiber-2.png)

`requestIdleCallback`APIï¼š
```js
window.requestIdleCallback(
    // æµè§ˆå™¨åœ¨ç©ºé—²æ—¶ï¼Œä¼šæ‰§è¡Œè¿™ä¸ªå›è°ƒï¼ŒåŒæ—¶ä¼šç»™å›è°ƒä¼ å…¥ä¸€ä¸ªdealineå¯¹è±¡
    // åœ¨dealineå¯¹è±¡ä¸­åŒ…å«ç€æµè§ˆå™¨ç›®å‰æœ‰å¤šå°‘æ—¶é—´ä¾›æˆ‘ä»¬æ‰§è¡Œ
    callback: (dealine: IdleDeadline) => void,
    // ä¸ºäº†é¿å…æµè§ˆå™¨å› ç¹å¿™ä¸”æ— å‰©ä½™æ—¶é—´å¯¼è‡´çš„é¥¿æ­»ï¼Œå¯ä¼ å…¥ä¸€ä¸ªè¶…æ—¶æ—¶é—´æ¥å¼ºåˆ¶è®©æµè§ˆå™¨æ‰§è¡Œå›è°ƒã€‚
    option?: { timeout: number }
)
```

`IdleDeadline`æ¥å£ï¼š
```js
interface IdleDealine {
    didTimeout: boolean // è¡¨ç¤ºä»»åŠ¡æ‰§è¡Œæ˜¯å¦è¶…è¿‡çº¦å®šæ—¶é—´
    timeRemaining(): DOMHighResTimeStamp // ä»»åŠ¡å¯ä¾›æ‰§è¡Œçš„å‰©ä½™æ—¶é—´
}
```

ç›®å‰`requestIdCallback`åªæœ‰Chromeæ”¯æŒã€‚Reactè‡ªå·±å®ç°äº†ä¸€ä¸ªï¼ˆåˆ©ç”¨`MessageChannel`å°†å›è°ƒå»¶è¿Ÿåˆ°â€œç»˜åˆ¶Paintâ€ä¹‹åæ‰§è¡Œï¼‰[æŸ¥çœ‹æºç ](https://github.com/facebook/react/blob/master/packages/scheduler/src/forks/SchedulerHostConfig.default.js)

å¦å¤–ï¼Œå¯¹äº`option`è¿™ä¸ªå‚æ•°æ‰€å®šä¹‰çš„**è¶…æ—¶æ—¶é—´å¹¶ä¸æ˜¯æ­»çš„ï¼Œä½ä¼˜å…ˆçº§å¯ä»¥æ…¢æ…¢ç­‰å¾…ï¼Œé«˜ä¼˜å…ˆçº§åº”è¯¥å…ˆè¢«æ‰§è¡Œ**ã€‚
```
ç›®å‰Reacté¢„å®šä¹‰äº†5ä¸ªä¼˜å…ˆçº§ï¼šImmediate(-1)ã€UserBlocking(250ms)ã€Normal(5s)ã€Low(10s)ã€Idle(æ²¡æœ‰è¶…æ—¶æ—¶é—´)
```











## å‚è€ƒé“¾æ¥

- [Virtual DOM åŠå†…æ ¸](https://zh-hans.reactjs.org/docs/faq-internals.html#what-is-react-fiber)

- [è¿™å¯èƒ½æ˜¯æœ€é€šä¿—çš„ React Fiber(æ—¶é—´åˆ†ç‰‡) æ‰“å¼€æ–¹å¼](https://juejin.im/post/5dadc6045188255a270a0f85#heading-2)