# React Fiber
> `React Fiber`æ˜¯ React16 ä¸­æ–°çš„åè°ƒå¼•æ“ã€‚
>
> å®ƒå¯ä»¥å®ç° â€œä»»åŠ¡åˆ†å‰²â€ ï¼Œè®© `è°ƒåº¦ç®—æ³•ï¼ˆreconciliationï¼‰` èƒ½å¤Ÿ â€œæš‚åœâ€ æˆ– â€œæ¢å¤â€
> 
> update: 2020-04-11

[[toc]]


## Fiberçš„åŸå› 
:::tip
Reactçš„æ ¸å¿ƒæµç¨‹åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š
 - reconciliationï¼ˆè°ƒåº¦ç®—æ³•ï¼‰
    - æ›´æ–°state/propsã€è°ƒç”¨ç”Ÿå‘½å‘¨æœŸé’©å­ã€ç”Ÿæˆvirtual domã€é€šè¿‡diffç®—æ³•ã€é‡æ–°æ¸²æŸ“
 - commit
    - æ“ä½œdomèŠ‚ç‚¹æ›´æ–°

:::
åœ¨ react16ä¹‹å‰ çš„ â€œè°ƒåº¦ç®—æ³•â€ ä¸­ï¼ŒReactæ˜¯ **åŒæ­¥é€’å½’æ¸²æŸ“** çš„ï¼Œå¹¶ä¸”æ— æ³•æš‚åœå’Œæ¢å¤ã€‚

æ‰€ä»¥å¯èƒ½åœ¨ â€œå¤§é‡çš„ç»„ä»¶æ¸²æŸ“â€æ—¶ï¼Œä¼š **å¯¼è‡´ ä¸»è¿›ç¨‹ é•¿æ—¶é—´è¢«å ç”¨ï¼Œå¯¼è‡´å‡ºç°å¡é¡¿å’Œæ‰å¸§çš„æƒ…å†µ** ã€‚

## åŸç†
`React Fiber`å¯ä»¥å®ç° **ä»»åŠ¡åˆ†å‰²** ã€‚

åŸç†ï¼š**å°†ä»»åŠ¡åˆ†å‰²æˆä¸€ä¸ªä¸ªç‹¬ç«‹çš„å°ä»»åŠ¡ï¼Œå°†å®ƒä»¬åˆ†æ•£åˆ° â€œæµè§ˆå™¨çš„ç©ºé—²æœŸâ€ æ‰§è¡Œ**ã€‚

> â€œæµè§ˆå™¨çš„ç©ºé—²æœŸâ€ éœ€è¦ç”± `requestIdleCallback` å‘ŠçŸ¥ã€‚

ç‰¹ç‚¹æ˜¯ï¼šèƒ½å……åˆ†åˆ©ç”¨ **ä¸»è¿›ç¨‹çš„äº‹ä»¶å¾ªç¯æœºåˆ¶** ã€‚

### å¤§è‡´æ•°æ®ç»“æ„
![alt](https://p6.music.126.net/obj/wo3DlcOGw6DClTvDisK1/5300246369/2160/0f3c/47b9/2535662b0dbc1eb8eb49a618270d4d95.png)

```js
class Fiber {
    constructor (instance) {
        this.instance = instance;

        // æŒ‡å‘ç¬¬ä¸€ä¸ª child èŠ‚ç‚¹
        this.child = child;
        // æŒ‡å‘çˆ¶èŠ‚ç‚¹
        this.return = parent;
        // æŒ‡å‘ç¬¬ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
        this.sibling = previous;

        // FiberèŠ‚ç‚¹é‡Œçš„Hooksé“¾è¡¨
        this.memoizedState = Hooks // <-- ä¼ªä»£ç 
    }
}
```

## å…·ä½“å®ç°æœºåˆ¶
### æš‚åœå’Œæ¢å¤
Reactv16 å°† `reconciliationï¼ˆè°ƒåº¦ç®—æ³•ï¼‰` å˜æˆäº† **å¯¹ é“¾è¡¨ çš„éå†** ã€‚
> æ—§ï¼š`stack reconciler`ï¼›æ–°ï¼š`fiber reconciler`

é€šè¿‡æŒ‡é’ˆæ˜ å°„ï¼Œæ¯ä¸ªå•å…ƒéƒ½è®°å½•ç€ä¸Šä¸€æ­¥ã€ä¸‹ä¸€æ­¥ï¼Œä»è€Œå¯ä»¥å®ç° **æš‚åœå’Œæ¢å¤** ã€‚

### åˆ†æ•£æ‰§è¡Œ
é€šè¿‡ 2 ä¸ªæµè§ˆå™¨APIï¼š`requestIdleCallback`ã€`requestAnimationFrame`

#### requestIdleCallback
è´Ÿè´£å¤„ç† ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ ã€‚
> æµè§ˆå™¨åœ¨ç©ºé—²æ—¶ï¼Œä¼šæ‰§è¡Œè¿™ä¸ªå›è°ƒ

`requestIdleCallback`APIï¼š
```js
window.requestIdleCallback(
    // æµè§ˆå™¨åœ¨ç©ºé—²æ—¶ï¼Œä¼šæ‰§è¡Œè¿™ä¸ªå›è°ƒï¼ŒåŒæ—¶ä¼šç»™å›è°ƒä¼ å…¥ä¸€ä¸ªdealineå¯¹è±¡
    // åœ¨dealineå¯¹è±¡ä¸­åŒ…å«ç€æµè§ˆå™¨ç›®å‰æœ‰å¤šå°‘æ—¶é—´ä¾›æˆ‘ä»¬æ‰§è¡Œ
    callback: (dealine: IdleDeadline) => void,
    // ä¸ºäº†é¿å…æµè§ˆå™¨å› ç¹å¿™ä¸”æ— å‰©ä½™æ—¶é—´å¯¼è‡´çš„é¥¿æ­»ï¼Œå¯ä¼ å…¥ä¸€ä¸ªè¶…æ—¶æ—¶é—´æ¥å¼ºåˆ¶è®©æµè§ˆå™¨æ‰§è¡Œå›è°ƒã€‚
    option?: { timeout: number }
)
```

#### requestAnimationFrame
è´Ÿè´£å¤„ç† é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ ã€‚

## Fiberçš„ç¼ºç‚¹
Fiber æ¯” Stack ä¼š **èŠ±è´¹æ›´å¤šçš„å†…å­˜å ç”¨ã€æ‰§è¡Œæ€§èƒ½** ã€‚
<!-- ï¼Œä½† React åŸºäº Fiber çš„æ€è·¯ä¼š**è®© JS æ‰§è¡Œæ€§èƒ½æå‡**ã€‚ -->

<!-- ## Fiber çš„è¡ç”Ÿäº§ç‰© Custom Renderer 
å®ƒå®šä¹‰äº†ä¸€ç³»åˆ—æ ‡å‡†åŒ–çš„æ¥å£ï¼Œä½¿æˆ‘ä»¬ä¸å¿…å…³å¿ƒ Fiber å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå°±å¯ä»¥é€šè¿‡è™šæ‹Ÿ DOM çš„æ–¹å¼é©±åŠ¨å®¿ä¸»ç¯å¢ƒã€‚ -->

<!-- ### å¯¹äºå‰ç«¯æ¡†æ¶ï¼Œâ€œè§£å†³å¡æ­»â€æœ‰ä¸‰ç§æ€è·¯:
 - **ä¼˜åŒ–JSå¼•æ“ä¸­çš„æ¯ä¸ªä»»åŠ¡ã€‚**
    > Vueä½¿ç”¨çš„æ˜¯è¿™ç§ã€‚å› ä¸ºå“åº”å¼æœºåˆ¶å¯ä»¥è®©Vueæ›´ç²¾ç¡®åœ°è¿›è¡ŒèŠ‚ç‚¹æ›´æ–°ã€‚

 - **å¿«é€Ÿå“åº”ç”¨æˆ·ï¼Œä¸é˜»å¡ç”¨æˆ·çš„äº¤äº’**
    > Reactä½¿ç”¨çš„æ˜¯è¿™ç§ï¼Œæ‰€ä»¥å¼•å…¥äº†Fiberæ¶æ„ã€‚

 - **å°è¯•Workerå¤šçº¿ç¨‹**
    > ä¿è¯çŠ¶æ€å’Œè§†å›¾çš„ä¸€è‡´æ€§å¾ˆéº»çƒ¦ã€‚Workerç›¸å½“äºJSå¼•æ“å‘æµè§ˆå™¨ç”³è¯·å¼€ä¸€ä¸ªworkerçº¿ç¨‹ã€‚"JSå¼•æ“çº¿ç¨‹"å’Œ"workerçº¿ç¨‹"ä¹‹é—´é€šè¿‡ç‰¹å®šæ–¹å¼é€šä¿¡ï¼ˆä½†workerçº¿ç¨‹å®Œå…¨å—æ§äºä¸»çº¿ç¨‹ï¼Œè€Œä¸”ä¸èƒ½æ“ä½œDOMï¼ŒJSå¼•æ“ä¾ç„¶æ˜¯å•çº¿ç¨‹çš„ï¼‰ã€‚

## ä»¥å‰çš„Reconciliationä¸å¯ä¸­æ–­ï¼ï¼ˆğŸ¤”å¼•å…¥Fiberçš„åŸå› ï¼‰
**é€šè¿‡æ¯”è¾ƒæ–°ã€æ—§Virtual DOMæ ‘æ¥æ‰¾å‡ºå˜åŠ¨äº†çš„èŠ‚ç‚¹ï¼Œç„¶ååŒæ­¥æ›´æ–°å®ƒä»¬ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºReconciliationï¼ˆåè°ƒï¼‰**ã€‚
> Reconciliationæ˜¯CPUå¯†é›†å‹æ“ä½œï¼Œç›¸å½“äºâ€œé•¿è¿›ç¨‹â€ã€‚
> 
> ç±»æ¯”â€œè¿›ç¨‹è°ƒåº¦â€ï¼Œæˆ‘ä»¬åº”è¯¥è®©é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹ï¼ˆæˆ–è€…çŸ­è¿›ç¨‹ï¼‰å…ˆè¿è¡Œï¼Œä¸èƒ½è®©é•¿è¿›ç¨‹é•¿æœŸéœ¸å èµ„æºã€‚

### å¼•å…¥Fiberå‰
å› ä¸º**Reconciliationä¸å¯ä¸­æ–­**ï¼Œæ‰€ä»¥Reactä¼šéœ¸å ç€**JSå¼•æ“çº¿ç¨‹**ï¼Œå¾ˆå¯èƒ½ä¼šå¯¼è‡´ç”¨æˆ·**å¾—ä¸åˆ°å“åº”**æˆ–**å¡é¡¿**ã€‚
> åŸå› ï¼šJSå¼•æ“çº¿ç¨‹ã€GUIæ¸²æŸ“çº¿ç¨‹**äº’æ–¥**ã€‚

### å¼•å…¥Fiberå
**Fiberæ˜¯React 16ä¸­æ–°çš„åè°ƒå¼•æ“**ã€‚
> å®ƒå¯ä»¥**ä½¿Reconciliationè¿‡ç¨‹å˜æˆå¯ä¸­æ–­**ï¼Œâ€œé€‚æ—¶â€åœ°è®©å‡ºCPUæ‰§è¡Œæƒã€‚

å¥½å¤„ï¼š
 - è®©æµè§ˆå™¨åŠæ—¶å“åº”äº¤äº’
 - åˆ†æ‰¹å»¶æ—¶å¯¹DOMè¿›è¡Œæ“ä½œ

é‚£å®ƒæ˜¯å¦‚ä½•ä½¿Reconciliationå˜å¾—å¯ä¸­æ–­çš„å‘¢ï¼Ÿ

## ä»€ä¹ˆæ˜¯Fiber
Fiberçš„æ€æƒ³ï¼š**å¯ä»¥ä¸­æ–­Reactçš„æ¸²æŸ“è¿‡ç¨‹ã€‚ä¸­æ–­åReactä¼šä¸»åŠ¨å°†æ§åˆ¶æƒäº¤å›æµè§ˆå™¨ï¼Œè®©ä½ç»™é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œç­‰åˆ°æµè§ˆå™¨ç©ºé—²åå†æ¢å¤æ¸²æŸ“ã€‚**

### è®©å‡ºæ§åˆ¶æƒæœ‰å“ªäº›éœ€è¦æ³¨æ„çš„ï¼Ÿ
2ä¸ªå…³é”®ç‚¹ï¼š
 - å¦‚ä½•**ä¸»åŠ¨å½’è¿˜æ§åˆ¶æƒ**ï¼ŸğŸ˜†
 - **ä»€ä¹ˆæ—¶å€™**å½’è¿˜ï¼Ÿâ°

#### 1ã€ä¸»åŠ¨å½’è¿˜æ§åˆ¶æƒ
å› ä¸ºæµè§ˆå™¨æ²¡æœ‰æŠ¢å æœºåˆ¶ï¼Œæ‰€ä»¥è¦é‡‡ç”¨**åˆä½œå¼è°ƒåº¦ï¼ˆCooperative Schedulingï¼‰æœºåˆ¶**ã€‚
 > ä¸â€œåˆä½œå¼è°ƒåº¦â€ç›¸åçš„æ˜¯â€œæŠ¢å å¼è°ƒåº¦â€ï¼ˆPreemptive Schedulingï¼‰

![alt](./img/fiber-1.png)

**åˆä½œå¼è°ƒåº¦æœºåˆ¶**çš„å¤§è‡´æ€æƒ³ï¼š

**Reactå‘æµè§ˆå™¨ç”³è¯·ä¸€ä¸ªâ€œæœ‰æœŸé™çš„æ‰§è¡Œæƒâ€ï¼›ï¼ˆç”³è¯·æ—¶é—´ç‰‡ï¼‰**

â¡ï¸ **æµè§ˆå™¨åœ¨æ¯å¸§å†…æ‰§è¡Œå®Œä»»åŠ¡ï¼ˆä¸€èˆ¬æ˜¯â€œç»˜åˆ¶â€ï¼‰åå°±ä¼šæ‰§è¡Œå›è°ƒï¼Œå‘Šè¯‰Reactèƒ½å€Ÿå¤šé•¿æ—¶é—´ï¼›**

â¡ï¸ **å€Ÿå®ŒåReactè¦æŒ‰ç…§çº¦å®šï¼Œâ€œä¸»åŠ¨â€å½’è¿˜æ§åˆ¶æƒç»™æµè§ˆå™¨**ã€‚
 > å½“ç„¶è¶…æ—¶ä¸è¿˜ï¼Œæµè§ˆå™¨ä¹Ÿæ˜¯æ²¡åŠæ³•çš„ğŸ¤·â€â™‚ï¸ã€‚å…¨å‡­è‡ªå¾‹ï¼Œäº’ç›¸ä¿¡ä»»ã€‚
```{2,3,4,5,6}
å› ä¸ºæµè§ˆå™¨ï¼ˆä¸¥æ ¼è¯´æ˜¯Rendererè¿›ç¨‹ï¼‰åœ¨ä¸€å¸§å†…å¯èƒ½ä¼šæ‰§è¡Œä¸‹åˆ—ä»»åŠ¡ï¼ˆæ‰§è¡Œé¡ºåºåŸºæœ¬å›ºå®šï¼‰ï¼š
 - å¤„ç†ç”¨æˆ·è¾“å…¥äº‹ä»¶ï¼ˆäº‹ä»¶è§¦å‘çº¿ç¨‹ï¼‰
 - JSæ‰§è¡Œï¼ˆJSå¼•æ“çº¿ç¨‹ï¼‰
 - requestAnimationè°ƒç”¨
 - å¸ƒå±€Layoutï¼ˆGUIæ¸²æŸ“çº¿ç¨‹ï¼‰
 - ç»˜åˆ¶Paintï¼ˆGUIæ¸²æŸ“çº¿ç¨‹ï¼‰
```
åœ¨æ¯ä¸€å¸§å†…ï¼Œå¦‚æœæµè§ˆå™¨åœ¨æ‰§è¡Œå®Œä¸Šé¢çš„ä»»åŠ¡åè¿˜æœ‰å‰©ä½™æ—¶é—´ï¼Œå°±ä¼šæ‰§è¡Œ`requestIdleCallback`ä¸­ä¼ å…¥çš„å›è°ƒï¼Œå¹¶ä¼ å…¥â€œèƒ½å€Ÿç»™Reactçš„æ—¶é—´é•¿åº¦â€ï¼š

![alt](./img/fiber-2.png)

`requestIdleCallback`APIï¼š
```js
window.requestIdleCallback(
    // æµè§ˆå™¨åœ¨ç©ºé—²æ—¶ï¼Œä¼šæ‰§è¡Œè¿™ä¸ªå›è°ƒï¼ŒåŒæ—¶ä¼šç»™å›è°ƒä¼ å…¥ä¸€ä¸ªdealineå¯¹è±¡
    // åœ¨dealineå¯¹è±¡ä¸­åŒ…å«ç€æµè§ˆå™¨ç›®å‰æœ‰å¤šå°‘æ—¶é—´ä¾›æˆ‘ä»¬æ‰§è¡Œ
    callback: (dealine: IdleDeadline) => void,
    // ä¸ºäº†é¿å…æµè§ˆå™¨å› ç¹å¿™ä¸”æ— å‰©ä½™æ—¶é—´å¯¼è‡´çš„é¥¿æ­»ï¼Œå¯ä¼ å…¥ä¸€ä¸ªè¶…æ—¶æ—¶é—´æ¥å¼ºåˆ¶è®©æµè§ˆå™¨æ‰§è¡Œå›è°ƒã€‚
    option?: { timeout: number }
)
```

`IdleDeadline`æ¥å£ï¼š
```js
interface IdleDealine {
    didTimeout: boolean // è¡¨ç¤ºä»»åŠ¡æ‰§è¡Œæ˜¯å¦è¶…è¿‡çº¦å®šæ—¶é—´
    timeRemaining(): DOMHighResTimeStamp // ä»»åŠ¡å¯ä¾›æ‰§è¡Œçš„å‰©ä½™æ—¶é—´
}
```
> ç›®å‰`requestIdCallback`åªæœ‰Chromeæ”¯æŒã€‚Reactè‡ªå·±å®ç°äº†ä¸€ä¸ªï¼ˆåˆ©ç”¨`MessageChannel`å°†å›è°ƒå»¶è¿Ÿåˆ°â€œç»˜åˆ¶Paintâ€ä¹‹åæ‰§è¡Œï¼‰[æŸ¥çœ‹æºç ](https://github.com/facebook/react/blob/master/packages/scheduler/src/forks/SchedulerHostConfig.default.js)

 > å¦å¤–ï¼Œåœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ—¶é—´ç‰‡åº”è¯¥åˆ’åˆ†ä¸º16msï¼Œå› ä¸ºäººç±»èƒ½æ„ŸçŸ¥åˆ°æœ€ä½é™åº¦çš„é¢‘ç‡æ˜¯æ¯ç§’60å¸§ï¼ˆ1000ms / 60 = 16 msï¼‰ã€‚



#### 2ã€ä»€ä¹ˆæ—¶å€™å½’è¿˜ï¼Ÿ
å› ä¸ºåœ¨æµè§ˆå™¨ä¸­æ²¡åŠæ³•åˆ¤æ–­åé¢æ˜¯å¦æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œæ‰€ä»¥è¦é€šè¿‡**è¶…æ—¶æ£€æŸ¥çš„æœºåˆ¶**æ¥åˆ¤æ–­æ˜¯å¦è¦å½’è¿˜æ§åˆ¶æƒã€‚

**è¶…æ—¶æ£€æŸ¥çš„æœºåˆ¶**çš„å¤§è‡´æ€æƒ³ï¼š

**ç»™Reactä¸€ä¸ªæ—¶é—´èŒƒå›´ï¼ˆåœ¨requestIdleCallbackä¸­çš„å›è°ƒä¼ å…¥çš„æ—¶é—´èŒƒå›´timeRemainingï¼‰**

â¡ï¸ **Reactåœ¨æ¯æ‰§è¡Œå®Œä¸€ä¸ªå°ä»»åŠ¡åæ£€æŸ¥æ˜¯å¦è¶…æ—¶ï¼›**

â¡ï¸ **è‹¥è¶…æ—¶å°±åœæ­¢æ‰§è¡Œï¼Œå°†æ§åˆ¶æƒå½’è¿˜ç»™æµè§ˆå™¨ã€‚**


## å‚è€ƒé“¾æ¥

- [ä»æµè§ˆå™¨å¤šè¿›ç¨‹åˆ°JSå•çº¿ç¨‹ï¼ŒJSè¿è¡Œæœºåˆ¶æœ€å…¨é¢çš„ä¸€æ¬¡æ¢³ç†](https://juejin.im/post/5a6547d0f265da3e283a1df7)

- [Virtual DOM åŠå†…æ ¸](https://zh-hans.reactjs.org/docs/faq-internals.html#what-is-react-fiber)

- [è¿™å¯èƒ½æ˜¯æœ€é€šä¿—çš„ React Fiber(æ—¶é—´åˆ†ç‰‡) æ‰“å¼€æ–¹å¼](https://juejin.im/post/5dadc6045188255a270a0f85#heading-2) -->
